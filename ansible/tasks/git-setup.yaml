- name: Git personal setup
  block:
    - name: Install latest Git
      community.general.homebrew:
        name: git
        state: latest

    - name: Create global .gitignore
      ansible.builtin.template:
        src: ../templates/.global_gitignore
        dest: ~/.global_gitignore
        mode: "0644"

    - name: Git personal setup email
      ansible.builtin.git_config:
        name: user.email
        scope: global
        value: "{{ git_email }}"

    - name: Git personal setup name
      ansible.builtin.git_config:
        name: user.name
        scope: global
        value: "{{ git_name }}"

    - name: Git set pull to rebase
      ansible.builtin.git_config:
        name: pull.rebase
        scope: global
        value: "true"

    - name: Set nvim as default git editor
      ansible.builtin.git_config:
        name: core.editor
        scope: global
        value: nvim

    - name: Set global git ignore
      ansible.builtin.git_config:
        name: core.excludesfile
        scope: global
        value: ~/.global_gitignore

    - name: Set git fetch to always prune
      ansible.builtin.git_config:
        name: fetch.prune
        scope: global
        value: "true"

    - name: Set global git default branch name
      ansible.builtin.git_config:
        name: init.defaultBranch
        scope: global
        value: main

    - name: Set autoSetupRemote to true to automatically set upstream branch on push
      ansible.builtin.git_config:
        name: push.autoSetupRemote
        scope: global
        value: "true"

    - name: Remove diff-so-fancy
      community.general.homebrew:
        name: diff-so-fancy
        state: absent

    - name: Set Git aliases
      ansible.builtin.git_config:
        name: alias.{{ item.name }}
        scope: global
        value: "{{ item.value }}"
      loop:
        - { name: "co", value: "checkout" }
        - { name: "br", value: "branch" }
        - { name: "ci", value: "commit" }
        - { name: "st", value: "status" }
        - { name: "last", value: "log -1 HEAD" }
        - { name: "unstage", value: "reset HEAD --" }
        - { name: "lg", value: "log --oneline --decorate --graph --all" }
        # Difftastic aliases
        - { name: "dlog", value: "-c diff.external=difft log --ext-diff" }
        - { name: "dshow", value: "-c diff.external=difft show --ext-diff" }
        - { name: "ddiff", value: "-c diff.external=difft diff" }
        - { name: "dl", value: "-c diff.external=difft log -p --ext-diff" }
        - { name: "ds", value: "-c diff.external=difft show --ext-diff" }
        - { name: "dft", value: "-c diff.external=difft diff" }

    - name: Enable colorized output
      ansible.builtin.git_config:
        name: color.ui
        scope: global
        value: auto

    - name: Reset core.pager to default (removing diff-so-fancy)
      ansible.builtin.git_config:
        name: core.pager
        scope: global
        state: absent

    - name: Remove diff-so-fancy color configurations
      ansible.builtin.git_config:
        name: "{{ item }}"
        scope: global
        state: absent
      loop:
        - "color.diff-highlight.oldNormal"
        - "color.diff-highlight.oldHighlight"
        - "color.diff-highlight.newNormal"
        - "color.diff-highlight.newHighlight"

    - name: Set difftastic as external diff tool
      ansible.builtin.git_config:
        name: diff.external
        scope: global
        value: difft

    - name: Set difftastic as default diff tool
      ansible.builtin.git_config:
        name: diff.tool
        scope: global
        value: difftastic

    - name: Configure difftastic difftool command
      ansible.builtin.git_config:
        name: difftool.difftastic.cmd
        scope: global
        value: 'difft "$LOCAL" "$REMOTE"'

    - name: Disable difftool prompt
      ansible.builtin.git_config:
        name: difftool.prompt
        scope: global
        value: "false"

    - name: Enable pager for difftool
      ansible.builtin.git_config:
        name: pager.difftool
        scope: global
        value: "true"

  tags:
    - git-personal
